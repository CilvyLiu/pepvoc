<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nova's Junior Lab | ç»¼åˆæµ‹éªŒä¸­å¿ƒ</title>
    <style>
        :root { --primary: #4D96FF; --secondary: #9B59B6; --success: #6BCB77; --bg: #F0F2F5; }
        body { font-family: 'system-ui', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .mode-selector { display: flex; gap: 10px; margin-bottom: 20px; background: #ddd; padding: 5px; border-radius: 50px; }
        .mode-btn { border: none; padding: 10px 25px; border-radius: 40px; cursor: pointer; font-weight: bold; transition: 0.3s; background: transparent; color: #666; }
        .mode-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .quiz-container { background: white; width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .progress { color: #888; font-size: 14px; margin-bottom: 10px; font-weight: bold; }
        .scene-tag { background: #F0F7FF; color: #4D96FF; padding: 4px 12px; border-radius: 50px; font-size: 12px; margin-bottom: 10px; display: none; }
        
        #question-box { font-size: 22px; font-weight: bold; color: #2D3436; margin-bottom: 20px; min-height: 60px; line-height: 1.4; }
        
        .options-grid { display: grid; gap: 12px; }
        .option-btn { 
            background: #F8F9FA; border: 2px solid #EEE; padding: 15px; border-radius: 15px; 
            text-align: left; font-size: 17px; cursor: pointer; transition: 0.2s; color: #444;
            -webkit-tap-highlight-color: transparent;
        }
        .option-btn.correct { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .option-btn.wrong { background: #FF6B6B !important; color: white !important; border-color: #FF6B6B !important; }

        .score-panel { text-align: center; display: none; }
        .score-val { font-size: 60px; color: var(--primary); font-weight: 900; }
        .btn-action { background: var(--primary); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 18px; margin-top: 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h1>ğŸš€ æµ‹éªŒæŒ‘æˆ˜ä¸­å¿ƒ</h1>

    <div class="mode-selector" id="mode-ui">
        <button class="mode-btn active" onclick="switchMode('words')">å•è¯æµ‹è¯•</button>
        <button class="mode-btn" onclick="switchMode('phrases')">è¡¨è¾¾å®æˆ˜</button>
    </div>

    <div class="quiz-container" id="quiz-ui">
        <div class="progress">Question <span id="current-idx">1</span> / 10</div>
        <div id="scene-tag" class="scene-tag"></div>
        <div id="question-box">å‡†å¤‡ä¸­...</div>
        <div class="options-grid" id="options"></div>
    </div>

    <div class="quiz-container score-panel" id="score-ui">
        <h2>ğŸ‰ æŒ‘æˆ˜å®Œæˆ!</h2>
        <div class="score-val" id="final-score">0</div>
        <p id="score-msg">Well done!</p>
        <button class="btn-action" onclick="location.reload()">é‡æ–°å¼€å§‹</button>
        <br>
        <button class="btn-action" style="background:#2D3436; margin-top: 10px;" onclick="location.href='index.html'">è¿”å›é¦–é¡µ</button>
    </div>

    <script>
        let currentMode = 'words'; // 'words' or 'phrases'
        let quizPool = [];
        let currentQuestion = 0;
        let score = 0;

        function speakUK(text) {
            const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
            const audio = new Audio(audioUrl);
            audio.play().catch(() => {
                window.speechSynthesis.cancel();
                const speech = new SpeechSynthesisUtterance(text);
                speech.lang = 'en-GB';
                speech.rate = 0.85;
                window.speechSynthesis.speak(speech);
            });
        }

        async function switchMode(mode) {
            currentMode = mode;
            currentQuestion = 0;
            score = 0;
            
            // UI æ›´æ–°
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(mode==='words'?'å•è¯':'è¡¨è¾¾')));
            document.getElementById('scene-tag').style.display = (mode === 'phrases') ? 'inline-block' : 'none';
            
            if (mode === 'words') {
                const units = [1, 2, 3, 4, 5, 6];
                const results = await Promise.all(units.map(u => fetch(`./unit${u}/data.json`).then(r => r.json())));
                quizPool = results.flat().sort(() => Math.random() - 0.5).slice(0, 10);
            } else {
                const res = await fetch('expressions_data.json');
                const data = await res.json();
                quizPool = Object.values(data).flat().sort(() => Math.random() - 0.5).slice(0, 10);
            }
            showQuestion();
        }

        function showQuestion() {
            const item = quizPool[currentQuestion];
            document.getElementById('current-idx').innerText = currentQuestion + 1;
            
            if (currentMode === 'words') {
                document.getElementById('question-box').innerText = `â€œ${item.chinese}â€çš„è‹±æ–‡æ˜¯ï¼Ÿ`;
            } else {
                document.getElementById('scene-tag').innerText = `åœºæ™¯ï¼š${item.scene || 'æ—¥å¸¸äº¤æµ'}`;
                document.getElementById('question-box').innerText = `ä½ æƒ³è¯´ï¼šâ€œ${item.zh}â€`;
            }
            
            // ç”Ÿæˆå¹²æ‰°é¡¹
            const correctKey = currentMode === 'words' ? 'word' : 'en';
            let distractors = quizPool
                .filter(w => w[correctKey] !== item[correctKey])
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(w => w[correctKey]);
            
            let choices = [...distractors, item[correctKey]].sort(() => Math.random() - 0.5);
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = "";
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = choice;
                btn.onclick = () => checkAnswer(choice, item[correctKey], btn);
                optionsDiv.appendChild(btn);
            });
        }

        function checkAnswer(selected, correct, btn) {
            document.querySelectorAll('.option-btn').forEach(b => b.onclick = null);

            if (selected === correct) {
                btn.classList.add('correct');
                score += 10;
                speakUK(correct);
            } else {
                btn.classList.add('wrong');
                document.querySelectorAll('.option-btn').forEach(b => {
                    if(b.innerText === correct) b.classList.add('correct');
                });
            }

            setTimeout(() => {
                currentQuestion++;
                if (currentQuestion < quizPool.length) {
                    showQuestion();
                } else {
                    document.getElementById('quiz-ui').style.display = 'none';
                    document.getElementById('mode-ui').style.display = 'none';
                    document.getElementById('score-ui').style.display = 'block';
                    document.getElementById('final-score').innerText = score;
                }
            }, 1500);
        }

        // åˆå§‹åŒ–åŠ è½½å•è¯æ¨¡å¼
        switchMode('words');

        // è§£é”éŸ³é¢‘
        document.addEventListener('touchstart', () => {
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
        }, { once: true });
    </script>
</body>
</html>
