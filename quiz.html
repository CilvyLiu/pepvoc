<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nova's Junior Lab | å•å…ƒæµ‹éªŒ</title>
    <style>
        :root { --primary: #4D96FF; --success: #6BCB77; --bg: #F0F2F5; }
        body { font-family: 'Comic Sans MS', 'Helvetica', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* è®¾ç½®ç•Œé¢ */
        .setup-container { background: white; width: 100%; max-width: 500px; border-radius: 24px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; box-sizing: border-box; }
        .setup-group { margin: 20px 0; text-align: left; }
        label { font-weight: bold; color: #555; display: block; margin-bottom: 10px; font-size: 14px; }
        select { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #F0F0F0; font-size: 16px; outline: none; background: #FAFAFA; cursor: pointer; }
        
        /* æµ‹éªŒå®¹å™¨ */
        .quiz-container { display: none; background: white; width: 100%; max-width: 500px; border-radius: 24px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); box-sizing: border-box; }
        .progress { color: #AAA; font-size: 13px; margin-bottom: 15px; letter-spacing: 1px; }
        .scene-box { background: #E8F2FF; color: #4D96FF; padding: 5px 15px; border-radius: 50px; font-size: 13px; font-weight: bold; display: inline-block; margin-bottom: 15px; }
        
        #question-box { font-size: 22px; font-weight: bold; color: #2D3436; margin-bottom: 25px; line-height: 1.5; }
        
        .options-grid { display: grid; gap: 12px; }
        .option-btn { 
            background: #FFF; border: 2px solid #F0F0F0; padding: 18px; border-radius: 18px; 
            text-align: left; font-size: 17px; cursor: pointer; transition: 0.2s; color: #444;
            -webkit-tap-highlight-color: transparent;
        }
        .option-btn.correct { background: var(--success) !important; color: white !important; border-color: var(--success) !important; }
        .option-btn.wrong { background: #FF6B6B !important; color: white !important; border-color: #FF6B6B !important; }

        .score-panel { text-align: center; display: none; }
        .btn-start { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 50px; font-size: 18px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-start:active { transform: scale(0.95); opacity: 0.9; }
    </style>
</head>
<body>

    <h1>ğŸš€ æµ‹éªŒä¸­å¿ƒ</h1>

    <div class="setup-container" id="setup-ui">
        <div class="setup-group">
            <label>è¯·é€‰æ‹©æµ‹è¯•ç±»å‹ï¼š</label>
            <select id="type-select">
                <option value="words">ğŸ”¤ å•è¯è¾¨æ (Vocabulary)</option>
                <option value="phrases">ğŸ—£ï¸ å¸¸ç”¨è¡¨è¾¾ (Expressions)</option>
            </select>
        </div>
        <div class="setup-group">
            <label>è¯·é€‰æ‹©æµ‹è¯•èŒƒå›´ï¼š</label>
            <select id="range-select">
                <option value="all">ğŸŒŸ å…¨å†Œç»¼åˆæŒ‘æˆ˜</option>
                <option value="1">Unit 1: Hello!</option>
                <option value="2">Unit 2: Family</option>
                <option value="3">Unit 3: Zoo</option>
                <option value="4">Unit 4: Farm</option>
                <option value="5">Unit 5: Colours</option>
                <option value="6">Unit 6: Birthday</option>
            </select>
        </div>
        <button class="btn-start" onclick="prepareQuiz()">å¼€å§‹æŒ‘æˆ˜ (å¼€å¯è‹±éŸ³æ¨¡å¼)</button>
    </div>

    <div class="quiz-container" id="quiz-ui">
        <div class="progress">QUESTION <span id="current-idx">1</span> / <span id="total-cnt">10</span></div>
        <div id="scene-tag" class="scene-box" style="display:none;"></div>
        <div id="question-box">Loading...</div>
        <div class="options-grid" id="options"></div>
    </div>

    <div class="quiz-container score-panel" id="score-ui">
        <h2>æµ‹éªŒå®Œæˆ!</h2>
        <div style="font-size:70px; color:var(--primary); font-weight:900; margin: 20px 0;" id="final-score">0</div>
        <p id="score-msg" style="color: #666; margin-bottom: 30px;"></p>
        <button class="btn-start" onclick="location.reload()">å†æ¥ä¸€å±€</button>
        <button class="btn-start" style="background:#2D3436; margin-top: 15px;" onclick="location.href='index.html'">è¿”å›ä¸»é¡µ</button>
    </div>

    <script>
        let quizPool = [];
        let currentIdx = 0;
        let score = 0;

        // æ ¸å¿ƒå‘éŸ³é€»è¾‘ï¼šå¼ºåˆ¶æ ‡å‡†è‹±éŸ³
        function speakUK(text) {
            // æ¥å£ 1: æœ‰é“æ ‡å‡†è‹±éŸ³
            const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(text)}&type=2`;
            const audio = new Audio(audioUrl);
            
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(() => {
                    // æ¥å£ 2: ç³»ç»Ÿ TTS å…œåº•ï¼ˆå¼ºåˆ¶ en-GBï¼‰
                    window.speechSynthesis.cancel();
                    const msg = new SpeechSynthesisUtterance(text);
                    msg.lang = 'en-GB';
                    msg.rate = 0.8;
                    window.speechSynthesis.speak(msg);
                });
            }
        }

        async function prepareQuiz() {
            // è§£é” iOS éŸ³é¢‘æƒé™
            window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));

            const mode = document.getElementById('type-select').value;
            const range = document.getElementById('range-select').value;
            
            try {
                if (mode === 'words') {
                    // é€»è¾‘ï¼šè¯»å– unitX/data.json
                    const units = range === 'all' ? [1,2,3,4,5,6] : [parseInt(range)];
                    const results = await Promise.all(units.map(u => fetch(`./unit${u}/data.json`).then(r => r.json())));
                    quizPool = results.flat();
                } else {
                    // é€»è¾‘ï¼šè¯»å–æ ¹ç›®å½• expressions_data.json å¹¶ç­›é€‰å•å…ƒ
                    const res = await fetch('expressions_data.json');
                    const data = await res.json();
                    if (range === 'all') {
                        quizPool = Object.values(data).flat();
                    } else {
                        quizPool = data[`unit${range}`] || [];
                    }
                }

                if (!quizPool || quizPool.length === 0) {
                    alert("è¯¥å•å…ƒæš‚æ— å†…å®¹ï¼Œè¯·æ£€æŸ¥æ•°æ®æ–‡ä»¶ï¼");
                    return;
                }

                // éšæœºæ´—ç‰Œå¹¶å– 10 é¢˜
                quizPool.sort(() => Math.random() - 0.5);
                quizPool = quizPool.slice(0, 10);

                document.getElementById('setup-ui').style.display = 'none';
                document.getElementById('quiz-ui').style.display = 'block';
                document.getElementById('total-cnt').innerText = quizPool.length;
                showQuestion();
            } catch (err) {
                alert("åŠ è½½å¤±è´¥ï¼šè¯·ç¡®è®¤ data.json æˆ– expressions_data.json è·¯å¾„æ­£ç¡®");
                console.error(err);
            }
        }

        function showQuestion() {
            const item = quizPool[currentIdx];
            const isWord = !!item.word; // åˆ¤æ–­æ˜¯å•è¯è¿˜æ˜¯è¡¨è¾¾
            const correctText = isWord ? item.word : item.en;
            const chineseText = isWord ? item.chinese : item.zh;
            
            document.getElementById('current-idx').innerText = currentIdx + 1;
            
            // å¦‚æœæ˜¯å¥å­æ¨¡å¼ï¼Œæ˜¾ç¤ºåœºæ™¯æ ‡ç­¾
            const sceneTag = document.getElementById('scene-tag');
            if (!isWord && item.scene) {
                sceneTag.innerText = `ğŸ¬ åœºæ™¯ï¼š${item.scene}`;
                sceneTag.style.display = 'inline-block';
            } else {
                sceneTag.style.display = 'none';
            }

            document.getElementById('question-box').innerText = `â€œ${chineseText}â€çš„æ­£ç¡®è‹±æ–‡æ˜¯ï¼Ÿ`;
            
            // ç”Ÿæˆå¹²æ‰°é¡¹
            let distractors = quizPool
                .filter(i => (isWord ? i.word : i.en) !== correctText)
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .map(i => isWord ? i.word : i.en);
            
            let choices = [...distractors, correctText].sort(() => Math.random() - 0.5);
            
            const optionsDiv = document.getElementById('options');
            optionsDiv.innerHTML = "";
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = choice;
                btn.onclick = () => checkAnswer(choice, correctText, btn);
                optionsDiv.appendChild(btn);
            });
        }

        function checkAnswer(selected, correct, btn) {
            document.querySelectorAll('.option-btn').forEach(b => b.onclick = null);

            if (selected === correct) {
                btn.classList.add('correct');
                score += (100 / quizPool.length);
                speakUK(correct); // å¼ºåˆ¶æ’­æ”¾è‹±éŸ³
            } else {
                btn.classList.add('wrong');
                document.querySelectorAll('.option-btn').forEach(b => {
                    if(b.innerText === correct) b.classList.add('correct');
                });
            }

            setTimeout(() => {
                currentIdx++;
                if (currentIdx < quizPool.length) {
                    showQuestion();
                } else {
                    showFinalResult();
                }
            }, 1500);
        }

        function showFinalResult() {
            document.getElementById('quiz-ui').style.display = 'none';
            document.getElementById('score-ui').style.display = 'block';
            const final = Math.round(score);
            document.getElementById('final-score').innerText = final;
            document.getElementById('score-msg').innerText = final >= 80 ? "Excellent! ä½ å¯¹è‹±å¼è‹±è¯­æŒæ¡å¾—çœŸæ£’ï¼" : "Keep trying! å¤šå¬å¬æ ‡å‡†è‹±éŸ³ä¼šè¿›æ­¥æ›´å¿«å“¦ï¼";
        }
    </script>
</body>
</html>
